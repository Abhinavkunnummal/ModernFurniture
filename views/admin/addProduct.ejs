<%- include('/home/ubuntu/ModernFurniture/views/admin_Layouts/header.ejs') %>
<%- include('/home/ubuntu/ModernFurniture/views/admin_Layouts/sidenav.ejs') %>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<main class="main-wrap">
  <header class="main-header navbar">
    <!-- Header content -->
  </header>

  <section class="content-main">
    <form id="productForm" action="/admin/products" method="post" class="forms-sample" enctype="multipart/form-data">
      <% if (typeof message != 'undefined') { %>
        <p class="text-danger"><%= message %></p>
      <% } %>
      <h1 class="mb-4">Add New Product</h1>
      <div class="row">
        <div class="col-md-6">
          <a href="/admin/Productlist" class="btn btn-warning mb-3">Product Lists</a>
          <div class="form-group mb-3">
            <label for="name">Product Name</label>
            <input type="text" class="form-control border" name="name" id="name" required>
            <div id="name-error" class="error-message"></div>
          </div>
          <div class="form-group mb-3">
            <label for="description">Product Description</label>
            <textarea class="form-control border" name="description" id="description" rows="5" required></textarea>
            <div id="description-error" class="error-message"></div>
          </div>
          <div class="form-group mb-3">
            <label for="productimages">Images (up to 4)</label>
            <input type="file" class="form-control border" id="productimages" name="images" accept="image/jpeg, image/png" multiple required>
            <div id="image-preview-container" class="mt-3 d-flex flex-wrap"></div>
            <div id="images-error" class="error-message"></div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="form-group mb-3">
            <label for="price">Price</label>
            <input type="number" class="form-control border" name="price" id="price" min="1" step="0.01" required>
            <div id="price-error" class="error-message"></div>
          </div>
          <div class="form-group mb-3">
            <label for="category">Category</label>
            <select class="form-control border" name="category" id="category" required>
              <% categoryData.forEach(item => { %>
                <% if(!item.Is_Listed){ %>
                  <option value="<%= item._id %>"><%= item.name %></option>
                <% } %>
              <% }) %>
            </select>
            <div id="category-error" class="error-message"></div>
          </div>
          <div class="form-group mb-3">
            <label for="quantity">Stock</label>
            <input type="number" class="form-control border" name="stock" id="quantity" min="1" required>
            <div id="quantity-error" class="error-message"></div>
          </div>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Create Product</button>
    </form>
  </section>

  <!-- Cropper Modal -->
  <div class="modal fade" id="cropperModal" tabindex="-1" aria-labelledby="cropperModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cropperModalLabel">Crop Image</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="img-container">
            <img id="image-to-crop" src="" alt="Image to crop">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="crop-button">Crop</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const maxImageCount = 4;
      const form = document.getElementById('productForm');
      const imageInput = document.getElementById('productimages');
      const previewContainer = document.getElementById('image-preview-container');
      const cropperModal = new bootstrap.Modal(document.getElementById('cropperModal'));
      const imageToCrop = document.getElementById('image-to-crop');
      let cropper;
      let currentImageElement;
      let croppedImages = [];

      imageInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files.length > maxImageCount) {
          showError('images', `Maximum ${maxImageCount} images allowed.`);
          imageInput.value = '';
        } else {
          showError('images', '');
          updateImagePreviews(files);
        }
      });

      function updateImagePreviews(files) {
        previewContainer.innerHTML = '';
        croppedImages = [];
        Array.from(files).forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('preview-image', 'me-2', 'mb-2');
            img.style.width = '100px';
            img.style.height = '100px';
            img.style.objectFit = 'cover';
            img.dataset.index = index;
            img.addEventListener('click', () => openCropper(img));
            previewContainer.appendChild(img);
            croppedImages.push({ file: file, cropped: false });
          };
          reader.readAsDataURL(file);
        });
      }

      function openCropper(img) {
        currentImageElement = img;
        imageToCrop.src = img.src;
        cropperModal.show();
        if (cropper) {
          cropper.destroy();
        }
        cropper = new Cropper(imageToCrop, {
          aspectRatio: 1,
          viewMode: 1,
        });
      }

      document.getElementById('crop-button').addEventListener('click', () => {
        const croppedCanvas = cropper.getCroppedCanvas({ width: 350, height: 450 });
        croppedCanvas.toBlob((blob) => {
          const index = parseInt(currentImageElement.dataset.index);
          croppedImages[index] = { file: blob, cropped: true };
          currentImageElement.src = croppedCanvas.toDataURL('image/jpeg');
          cropperModal.hide();
        }, 'image/jpeg');
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (validateForm()) {
          const formData = new FormData(form);
          croppedImages.forEach((img, index) => {
            formData.append('images', img.file, `image_${index}${img.cropped ? '_cropped' : ''}.jpg`);
          });

          try {
            const response = await fetch('/admin/products', {
              method: 'POST',
              body: formData
            });
            if (response.ok) {
              window.location.href = "/admin/Productlist";
            } else {
              const errorData = await response.json();
              showError('form', errorData.message);
            }
          } catch (error) {
            console.error('Error:', error);
            showError('form', 'An error occurred while submitting the form.');
          }
        }
      });

      function validateForm() {
        let isValid = true;
        const fields = ['name', 'description', 'price', 'category', 'quantity', 'productimages'];
        fields.forEach(field => {
          const input = document.getElementById(field);
          if (!input.value) {
            showError(field, `${field.charAt(0).toUpperCase() + field.slice(1)} is required.`);
            isValid = false;
          } else {
            showError(field, '');
          }
        });
        return isValid;
      }

      function showError(fieldId, message) {
        const errorDiv = document.getElementById(`${fieldId}-error`);
        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.style.display = message ? 'block' : 'none';
        }
      }
    });
  </script>
</main>